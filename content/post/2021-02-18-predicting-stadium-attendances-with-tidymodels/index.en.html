---
title: Predicting NFL stadium attendances with tidymodels (WIP)
author: James
date: '2021-02-18'
slug: predicting-stadium-attendances-with-tidymodels
categories: []
tags: []
subtitle: ''
summary: ''
authors: []
lastmod: '2021-02-18T22:07:35Z'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
draft: no
---

<script src="{{< blogdown/postref >}}index.en_files/header-attrs/header-attrs.js"></script>


<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>In this post I’m going to be trying out the new <a href="https://www.tidymodels.org/">tidymodels framework</a> in R.</p>
<p>I’ve been reading through the corresponding <a href="https://www.tmwr.org/">book</a> and it looks to me like a real game-changer for building robust statistical/ML models quickly in the R language. But I’ve had enough of reading! Time to test it out.</p>
<p>The data I’m going to be using is a <a href="https://github.com/rfordatascience/tidytuesday">#TidyTuesday dataset</a> from last year related to crowd attendances in the American national football league (NFL). <del>I’ll avoid making a little dig about how this isn’t proper football in the British sense of the word because that would be churlish.</del></p>
<p>The tidymodels framework covers all stages of the modeling lifecyle, from data preprocessing and resampling to model tuning and evaluation. In this post I’m only going to look at <em>data resampling</em> and <em>model evaluation</em>. I’ll look at the other stages in future posts.</p>
<p>Credit to Julia Silge, whose <a href="https://juliasilge.com/blog/intro-tidymodels/">work</a> served as the inspiration for this post.</p>
</div>
<div id="load-and-inspect-the-data" class="section level2">
<h2>Load and inspect the data</h2>
<pre class="r"><code>attendance &lt;- read_csv(&quot;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-04/attendance.csv&quot;)
results &lt;- read_csv(&quot;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-04/standings.csv&quot;)</code></pre>
<p>Our first dataset is about attendance per team every week since the year 2000:</p>
<pre class="r"><code>head(attendance)</code></pre>
<pre><code>## # A tibble: 6 x 8
##   team    team_name  year  total   home   away  week weekly_attendance
##   &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;             &lt;dbl&gt;
## 1 Arizona Cardinals  2000 893926 387475 506451     1             77434
## 2 Arizona Cardinals  2000 893926 387475 506451     2             66009
## 3 Arizona Cardinals  2000 893926 387475 506451     3                NA
## 4 Arizona Cardinals  2000 893926 387475 506451     4             71801
## 5 Arizona Cardinals  2000 893926 387475 506451     5             66985
## 6 Arizona Cardinals  2000 893926 387475 506451     6             44296</code></pre>
<p>And our second dataset gives us results stats for each team about things like final standings, wins/losses, points for/against and whether the team made the playoffs for every year since 2000.</p>
<pre class="r"><code>glimpse(results) # glimpse() rather than head() as there are many columns</code></pre>
<pre><code>## Rows: 638
## Columns: 15
## $ team                 &lt;chr&gt; &quot;Miami&quot;, &quot;Indianapolis&quot;, &quot;New York&quot;, &quot;Buffalo&quot;, …
## $ team_name            &lt;chr&gt; &quot;Dolphins&quot;, &quot;Colts&quot;, &quot;Jets&quot;, &quot;Bills&quot;, &quot;Patriots&quot;…
## $ year                 &lt;dbl&gt; 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, …
## $ wins                 &lt;dbl&gt; 11, 10, 9, 8, 5, 13, 12, 9, 7, 4, 3, 12, 11, 7, …
## $ loss                 &lt;dbl&gt; 5, 6, 7, 8, 11, 3, 4, 7, 9, 12, 13, 4, 5, 9, 10,…
## $ points_for           &lt;dbl&gt; 323, 429, 321, 315, 276, 346, 333, 321, 367, 185…
## $ points_against       &lt;dbl&gt; 226, 326, 321, 350, 338, 191, 165, 255, 327, 359…
## $ points_differential  &lt;dbl&gt; 97, 103, 0, -35, -62, 155, 168, 66, 40, -174, -2…
## $ margin_of_victory    &lt;dbl&gt; 6.1, 6.4, 0.0, -2.2, -3.9, 9.7, 10.5, 4.1, 2.5, …
## $ strength_of_schedule &lt;dbl&gt; 1.0, 1.5, 3.5, 2.2, 1.4, -1.3, -2.5, -0.2, -1.4,…
## $ simple_rating        &lt;dbl&gt; 7.1, 7.9, 3.5, 0.0, -2.5, 8.3, 8.0, 3.9, 1.1, -1…
## $ offensive_ranking    &lt;dbl&gt; 0.0, 7.1, 1.4, 0.5, -2.7, 1.5, 0.0, 0.6, 3.2, -8…
## $ defensive_ranking    &lt;dbl&gt; 7.1, 0.8, 2.2, -0.5, 0.2, 6.8, 8.0, 3.3, -2.1, -…
## $ playoffs             &lt;chr&gt; &quot;Playoffs&quot;, &quot;Playoffs&quot;, &quot;No Playoffs&quot;, &quot;No Playo…
## $ sb_winner            &lt;chr&gt; &quot;No Superbowl&quot;, &quot;No Superbowl&quot;, &quot;No Superbowl&quot;, …</code></pre>
<p>Let’s join these datasets by team and year to get one large dataset combining data on results and attendances which we can use for modelling.</p>
<pre class="r"><code>attendance_joined &lt;- attendance %&gt;%
  left_join(results,
    by = c(&quot;year&quot;, &quot;team_name&quot;, &quot;team&quot;)
  )

glimpse(attendance_joined)</code></pre>
<pre><code>## Rows: 10,846
## Columns: 20
## $ team                 &lt;chr&gt; &quot;Arizona&quot;, &quot;Arizona&quot;, &quot;Arizona&quot;, &quot;Arizona&quot;, &quot;Ari…
## $ team_name            &lt;chr&gt; &quot;Cardinals&quot;, &quot;Cardinals&quot;, &quot;Cardinals&quot;, &quot;Cardinal…
## $ year                 &lt;dbl&gt; 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, …
## $ total                &lt;dbl&gt; 893926, 893926, 893926, 893926, 893926, 893926, …
## $ home                 &lt;dbl&gt; 387475, 387475, 387475, 387475, 387475, 387475, …
## $ away                 &lt;dbl&gt; 506451, 506451, 506451, 506451, 506451, 506451, …
## $ week                 &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 1…
## $ weekly_attendance    &lt;dbl&gt; 77434, 66009, NA, 71801, 66985, 44296, 38293, 62…
## $ wins                 &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, …
## $ loss                 &lt;dbl&gt; 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, …
## $ points_for           &lt;dbl&gt; 210, 210, 210, 210, 210, 210, 210, 210, 210, 210…
## $ points_against       &lt;dbl&gt; 443, 443, 443, 443, 443, 443, 443, 443, 443, 443…
## $ points_differential  &lt;dbl&gt; -233, -233, -233, -233, -233, -233, -233, -233, …
## $ margin_of_victory    &lt;dbl&gt; -14.6, -14.6, -14.6, -14.6, -14.6, -14.6, -14.6,…
## $ strength_of_schedule &lt;dbl&gt; -0.7, -0.7, -0.7, -0.7, -0.7, -0.7, -0.7, -0.7, …
## $ simple_rating        &lt;dbl&gt; -15.2, -15.2, -15.2, -15.2, -15.2, -15.2, -15.2,…
## $ offensive_ranking    &lt;dbl&gt; -7.2, -7.2, -7.2, -7.2, -7.2, -7.2, -7.2, -7.2, …
## $ defensive_ranking    &lt;dbl&gt; -8.1, -8.1, -8.1, -8.1, -8.1, -8.1, -8.1, -8.1, …
## $ playoffs             &lt;chr&gt; &quot;No Playoffs&quot;, &quot;No Playoffs&quot;, &quot;No Playoffs&quot;, &quot;No…
## $ sb_winner            &lt;chr&gt; &quot;No Superbowl&quot;, &quot;No Superbowl&quot;, &quot;No Superbowl&quot;, …</code></pre>
</div>
<div id="data-exploration" class="section level2">
<h2>Data exploration</h2>
<p>It’s always good practice to look at your data first to get a sense of it before trying any modelling. I like to do this using the <code>skim</code> function from R’s <code>skimr</code> package:</p>
<pre class="r"><code>skimr::skim(attendance_joined)</code></pre>
<table>
<caption><span id="tab:unnamed-chunk-5">Table 1: </span>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">attendance_joined</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">10846</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">20</td>
</tr>
<tr class="even">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">character</td>
<td align="left">4</td>
</tr>
<tr class="odd">
<td align="left">numeric</td>
<td align="left">16</td>
</tr>
<tr class="even">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Group variables</td>
<td align="left">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">min</th>
<th align="right">max</th>
<th align="right">empty</th>
<th align="right">n_unique</th>
<th align="right">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">team</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">5</td>
<td align="right">13</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">team_name</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">4</td>
<td align="right">10</td>
<td align="right">0</td>
<td align="right">32</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">playoffs</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">8</td>
<td align="right">11</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">sb_winner</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">12</td>
<td align="right">13</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table>
<colgroup>
<col width="17%" />
<col width="8%" />
<col width="11%" />
<col width="9%" />
<col width="7%" />
<col width="7%" />
<col width="8%" />
<col width="8%" />
<col width="9%" />
<col width="8%" />
<col width="4%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">year</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">2009.53</td>
<td align="right">5.75</td>
<td align="right">2000.0</td>
<td align="right">2005.0</td>
<td align="right">2010.0</td>
<td align="right">2015.00</td>
<td align="right">2019.0</td>
<td align="left">▇▇▇▇▇</td>
</tr>
<tr class="even">
<td align="left">total</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">1080910.03</td>
<td align="right">72876.97</td>
<td align="right">760644.0</td>
<td align="right">1040509.0</td>
<td align="right">1081089.5</td>
<td align="right">1123230.00</td>
<td align="right">1322087.0</td>
<td align="left">▁▁▇▆▁</td>
</tr>
<tr class="odd">
<td align="left">home</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">540455.01</td>
<td align="right">66774.65</td>
<td align="right">202687.0</td>
<td align="right">504360.0</td>
<td align="right">543185.0</td>
<td align="right">578342.00</td>
<td align="right">741775.0</td>
<td align="left">▁▁▅▇▁</td>
</tr>
<tr class="even">
<td align="left">away</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">540455.01</td>
<td align="right">25509.33</td>
<td align="right">450295.0</td>
<td align="right">524974.0</td>
<td align="right">541757.0</td>
<td align="right">557741.00</td>
<td align="right">601655.0</td>
<td align="left">▁▂▇▇▂</td>
</tr>
<tr class="odd">
<td align="left">week</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">9.00</td>
<td align="right">4.90</td>
<td align="right">1.0</td>
<td align="right">5.0</td>
<td align="right">9.0</td>
<td align="right">13.00</td>
<td align="right">17.0</td>
<td align="left">▇▆▆▆▇</td>
</tr>
<tr class="even">
<td align="left">weekly_attendance</td>
<td align="right">638</td>
<td align="right">0.94</td>
<td align="right">67556.88</td>
<td align="right">9022.02</td>
<td align="right">23127.0</td>
<td align="right">63245.5</td>
<td align="right">68334.0</td>
<td align="right">72544.75</td>
<td align="right">105121.0</td>
<td align="left">▁▁▇▃▁</td>
</tr>
<tr class="odd">
<td align="left">wins</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">7.98</td>
<td align="right">3.08</td>
<td align="right">0.0</td>
<td align="right">6.0</td>
<td align="right">8.0</td>
<td align="right">10.00</td>
<td align="right">16.0</td>
<td align="left">▂▆▇▆▂</td>
</tr>
<tr class="even">
<td align="left">loss</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">7.98</td>
<td align="right">3.08</td>
<td align="right">0.0</td>
<td align="right">6.0</td>
<td align="right">8.0</td>
<td align="right">10.00</td>
<td align="right">16.0</td>
<td align="left">▂▆▇▆▂</td>
</tr>
<tr class="odd">
<td align="left">points_for</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">350.28</td>
<td align="right">71.35</td>
<td align="right">161.0</td>
<td align="right">299.0</td>
<td align="right">348.0</td>
<td align="right">396.00</td>
<td align="right">606.0</td>
<td align="left">▂▇▇▂▁</td>
</tr>
<tr class="even">
<td align="left">points_against</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">350.28</td>
<td align="right">59.50</td>
<td align="right">165.0</td>
<td align="right">310.0</td>
<td align="right">347.0</td>
<td align="right">392.00</td>
<td align="right">517.0</td>
<td align="left">▁▃▇▆▁</td>
</tr>
<tr class="odd">
<td align="left">points_differential</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.00</td>
<td align="right">101.01</td>
<td align="right">-261.0</td>
<td align="right">-75.0</td>
<td align="right">1.5</td>
<td align="right">73.00</td>
<td align="right">315.0</td>
<td align="left">▂▆▇▅▁</td>
</tr>
<tr class="even">
<td align="left">margin_of_victory</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.00</td>
<td align="right">6.32</td>
<td align="right">-16.3</td>
<td align="right">-4.7</td>
<td align="right">0.1</td>
<td align="right">4.60</td>
<td align="right">19.7</td>
<td align="left">▂▆▇▅▁</td>
</tr>
<tr class="odd">
<td align="left">strength_of_schedule</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.00</td>
<td align="right">1.63</td>
<td align="right">-4.6</td>
<td align="right">-1.1</td>
<td align="right">0.0</td>
<td align="right">1.20</td>
<td align="right">4.3</td>
<td align="left">▁▅▇▅▁</td>
</tr>
<tr class="even">
<td align="left">simple_rating</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.00</td>
<td align="right">6.20</td>
<td align="right">-17.4</td>
<td align="right">-4.5</td>
<td align="right">0.0</td>
<td align="right">4.50</td>
<td align="right">20.1</td>
<td align="left">▁▆▇▅▁</td>
</tr>
<tr class="odd">
<td align="left">offensive_ranking</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.00</td>
<td align="right">4.34</td>
<td align="right">-11.7</td>
<td align="right">-3.2</td>
<td align="right">0.0</td>
<td align="right">2.70</td>
<td align="right">15.9</td>
<td align="left">▁▇▇▂▁</td>
</tr>
<tr class="even">
<td align="left">defensive_ranking</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">0.00</td>
<td align="right">3.56</td>
<td align="right">-9.8</td>
<td align="right">-2.4</td>
<td align="right">0.1</td>
<td align="right">2.50</td>
<td align="right">9.8</td>
<td align="left">▁▅▇▅▁</td>
</tr>
</tbody>
</table>
<p>This looks like a pretty kind dataset - In over 10,000 rows of data we have only 638 missing values (all being the <code>weekly_attendance</code> - our label to be predicted) and none of the features look particularly skewed.</p>
<p>Let’s see how weekly attendance varied over the 20 years of data we have by utilising box and whisker plots. Has going to NFL mathes become much more popular?</p>
<pre class="r"><code>attendance_joined %&gt;%
  mutate(year = factor(year)) %&gt;%
  ggplot(aes(year, weekly_attendance, fill = year)) +
  geom_boxplot(show.legend = FALSE, outlier.alpha = 0.5) +
  labs(
    x = &quot;Year of NFL season&quot;,
    y = &quot;Weekly NFL game attendance&quot;
  )</code></pre>
<p><img src="staticunnamed-chunk-6-1.png" width="2100" /></p>
<p>Not much variation really. 2020’s figures would presumably be much lower due to the pandemic but sadly we don’t have them!</p>
<p>Let’s see how it varies by week - maybe attendances go down towards the end of the season as most teams have less to play for?</p>
<pre class="r"><code>attendance_joined %&gt;%
  mutate(week = factor(week)) %&gt;%
  ggplot(aes(week, weekly_attendance, fill = week)) +
  geom_boxplot(show.legend = FALSE, outlier.alpha = 0.5) +
  labs(
    x = &quot;Week of NFL season&quot;,
    y = &quot;Weekly NFL game attendance&quot;
  )</code></pre>
<p><img src="staticunnamed-chunk-7-1.png" width="2100" /></p>
<p>Again, very little variation. Not much to see here.</p>
<p>In a more comprehensive analysis I would do some feature selection and engineering but that’s not the purpose of this exercise - I just want to build a model to predict <code>weekly_attendance</code> based on all the predcitors I have.</p>
</div>
<div id="building-models" class="section level2">
<h2>Building models</h2>
<p>[Work in progress]</p>
</div>
